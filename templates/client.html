<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>İstemci</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>İstemci (Mesaj Gönder)</h2>
        <label>Mesaj:</label>
        <input type="text" id="message">
        
        <label>Anahtar:</label>
        <input type="text" id="key" placeholder="Vigenere/Substitution: anahtar kelime, Rail Fence: ray sayısı (örn: 3), Route Cipher: genişlik (örn: 5), Columnar Transposition: anahtar (örn: truva), Hill: matris (örn: 3,3,2,5), DES: 8 karakterlik anahtar (örn: 12345678)">

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" onclick="exchangeKey('AES')">RSA ile AES Anahtarı Gönder</button>
            <button type="button" onclick="exchangeKey('DES')">RSA ile DES Anahtarı Gönder</button>
        </div>
        
        <label>Algoritma:</label>
        <select id="algo">
            <option value="Caesar">Caesar</option>
            <option value="Vigenere">Vigenere</option>
            <option value="Substitution">Substitution</option>
            <option value="Affine">Affine</option>
            <option value="Rail Fence">Rail Fence</option>
            <option value="Route Cipher">Route Cipher</option>
            <option value="Columnar Transposition">Columnar Transposition</option>
            <option value="Polybius">Polybius</option>
            <option value="Pigpen">Pigpen</option>
            <option value="Hill">Hill</option>
            <option value="DES">DES</option>
            <option value="DES (Library)">DES (Library)</option>
            <option value="RSA">RSA</option>
            <option value="AES">AES</option>
            <option value="AES (Manual)">AES (Manual)</option>
        </select>

        <button onclick="sendMessage()">Şifrele ve Gönder</button>
        <div class="encrypted" id="encrypted"></div>
        
        <a href="/" class="back-home-btn">Ana Sayfaya Dön</a>
    </div>

    <script>
        const socket = io();

        // --- RSA key exchange helpers ---
        let rsaPublicKeyPem = null;

        socket.emit('get_rsa_public_key');
        socket.on('rsa_public_key', (data) => {
            rsaPublicKeyPem = data.public_key;
        });

        socket.on('key_exchange_ok', (data) => {
            if (data.ok) {
                alert(data.algo + " anahtarı sunucuya iletildi (RSA ile).");
            } else {
                alert("Anahtar iletimi başarısız.");
            }
        });

        function exchangeKey(algo) {
            if (!rsaPublicKeyPem) return alert("RSA public key henüz gelmedi!");
            const key = document.getElementById('key').value;

            if (algo === "AES" && key.length < 16) {
                return alert("AES için en az 16 karakterlik anahtar gir (16 byte mantığında).");
            }
            if (algo === "DES" && key.length < 8) {
                return alert("DES için en az 8 karakterlik anahtar gir.");
            }

            try {
                const publicKey = forge.pki.publicKeyFromPem(rsaPublicKeyPem);
                // OAEP (SHA-1) -> Python'daki PKCS1_OAEP default ile uyumlu
                const encryptedBytes = publicKey.encrypt(key, 'RSA-OAEP');
                const encryptedB64 = forge.util.encode64(encryptedBytes);

                socket.emit('exchange_session_key', {
                    algo: algo,
                    encrypted_key: encryptedB64
                });
            } catch (e) {
                console.error(e);
                alert("RSA şifreleme hatası: console'a bak.");
            }
        }

        function sendMessage() {
            const message = document.getElementById('message').value;
            const key = document.getElementById('key').value;
            const algo = document.getElementById('algo').value;

            if (!message) return alert("Mesaj boş olamaz!");

            socket.emit('send_message', {message, key, algo});
            document.getElementById('encrypted').innerText = "Mesaj Gönderildi!";
            document.getElementById('message').value = "";
        }
    </script>
</body>
</html>