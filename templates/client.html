<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>İstemci</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>İstemci (Mesaj Gönder)</h2>

        <label>Mesaj:</label>
        <input type="text" id="message">

        <hr style="margin:16px 0; opacity:0.3;">
        <h3 style="margin:0 0 8px 0;">Dosya Şifreleme</h3>
        <label>Dosya Seç (her tür):</label>
        <input type="file" id="binFileInput">
        <div class="encrypted" id="binFileStatus"></div>

        <div style="margin-top:8px;">
            <button type="button" id="downloadEncJsonClient" style="display:none;">Şifreli Dosyayı JSON indir</button>
            <button type="button" id="downloadEncTxtClient" style="display:none; margin-left:8px;">Şifreli Dosyayı TXT indir</button>
        </div>

        <label style="margin-top:12px;">Anahtar:</label>
        <input
            type="text"
            id="key"
            placeholder="Manuel modlar: DES (Manual)=8 karakter, AES (Manual)=16 karakter. Diğerleri kendi anahtar formatına göre."
        >

        <label>Algoritma:</label>
        <select id="algo">
            <option value="Caesar">Caesar</option>
            <option value="Vigenere">Vigenere</option>
            <option value="Substitution">Substitution</option>
            <option value="Affine">Affine</option>
            <option value="Rail Fence">Rail Fence</option>
            <option value="Route Cipher">Route Cipher</option>
            <option value="Columnar Transposition">Columnar Transposition</option>
            <option value="Polybius">Polybius</option>
            <option value="Pigpen">Pigpen</option>
            <option value="Hill">Hill</option>

            <option value="DES (Manual)">DES (Manual)</option>
            <option value="DES (Library)">DES (Library)</option>

            <option value="AES (Manual)">AES (Manual)</option>
            <option value="AES (Library)">AES (Library)</option>

            <option value="RSA">RSA</option>
        </select>

        <button type="button" onclick="sendMessage()">Şifrele ve Gönder</button>

        <div class="encrypted" id="status"></div>

        <a href="/" class="back-home-btn">Ana Sayfaya Dön</a>
    </div>

    <script>
        const socket = io();

        // ===== DOSYA (client) =====
        let selectedBinFileB64 = null;
        let selectedBinFileName = null;

        document.addEventListener("DOMContentLoaded", () => {
            const binInput = document.getElementById("binFileInput");
            const status = document.getElementById("binFileStatus");

            if (binInput) {
                binInput.addEventListener("change", async (e) => {
                    const f = e.target.files?.[0];
                    if (!f) return;

                    selectedBinFileName = f.name;

                    const buf = await f.arrayBuffer();
                    const bytes = new Uint8Array(buf);

                    // ArrayBuffer -> base64
                    let binary = "";
                    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
                    selectedBinFileB64 = btoa(binary);

                    if (status) status.innerText = `Seçildi: ${selectedBinFileName} (${bytes.length} byte)`;

                    // yeni dosya seçilince eski şifreli çıktı butonlarını kapat
                    hideDownloadButtons();
                });
            }

            // download butonları
            const bj = document.getElementById("downloadEncJsonClient");
            const bt = document.getElementById("downloadEncTxtClient");
            if (bj) bj.addEventListener("click", downloadEncJsonClient);
            if (bt) bt.addEventListener("click", downloadEncTxtClient);
        });

        function isFileMode() {
            return !!selectedBinFileB64;
        }

        function fileAlgoAllowed(algo) {
            return ["AES (Manual)","AES (Library)","DES (Manual)","DES (Library)","RSA"].includes(algo);
        }
        // ==========================

        // ===== Client'ta şifreli dosyayı indirmek için =====
        let lastEncIsFile = false;
        let lastEncFileName = "dosya.bin";
        let lastEncAlgorithm = null;
        let lastEncCiphertext = null;

        function safeAlgoSlug(algo) {
            return (algo || "ENC").replace(/[^a-zA-Z0-9]+/g, "_");
        }

        function showDownloadButtons(show) {
            const bj = document.getElementById("downloadEncJsonClient");
            const bt = document.getElementById("downloadEncTxtClient");
            if (bj) bj.style.display = show ? "inline-block" : "none";
            if (bt) bt.style.display = show ? "inline-block" : "none";
        }

        function hideDownloadButtons() {
            showDownloadButtons(false);
            lastEncIsFile = false;
            lastEncCiphertext = null;
        }

        function downloadEncJsonClient() {
            if (!lastEncCiphertext) return alert("İndirilecek şifreli dosya yok.");
            const pack = {
                is_file: true,
                file_name: lastEncFileName || "dosya.bin",
                algorithm: lastEncAlgorithm || document.getElementById("algo").value,
                ciphertext: lastEncCiphertext
            };
            const blob = new Blob([JSON.stringify(pack, null, 2)], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${pack.file_name}.${safeAlgoSlug(pack.algorithm)}.enc.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function downloadEncTxtClient() {
            if (!lastEncCiphertext) return alert("İndirilecek şifreli içerik yok.");
            const algo = lastEncAlgorithm || document.getElementById("algo").value;
            const name = lastEncFileName || "dosya.bin";
            const blob = new Blob([lastEncCiphertext], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `${name}.${safeAlgoSlug(algo)}.enc.txt`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
        // ================================================

        let rsaPublicKeyPem = null;
        let pendingSendPayload = null;

        // RSA public key iste
        socket.emit('get_rsa_public_key');
        socket.on('rsa_public_key', (data) => {
            rsaPublicKeyPem = data.public_key;
        });

        socket.on('key_exchange_ok', (data) => {
            if (data && data.ok) {
                document.getElementById('status').innerText = "Oturum anahtarı alındı. Gönderiliyor...";

                if (pendingSendPayload) {
                    socket.emit('send_message', pendingSendPayload);
                    pendingSendPayload = null;
                }
            } else {
                alert("Anahtar iletimi başarısız: " + (data && data.message ? data.message : ""));
                document.getElementById('status').innerText = "";
                pendingSendPayload = null;
            }
        });

        socket.on('error', (data) => {
            alert("Hata: " + (data && data.message ? data.message : "Bilinmeyen hata"));
        });

        // Şifreli çıktı server'dan dönünce burada yakalayıp client'ta indirilebilir yapıyoruz
        socket.on('receive_message', (data) => {
            const st = document.getElementById('status');

            if (data && data.message) {
                if (data.is_file) {
                    lastEncIsFile = true;
                    lastEncFileName = data.file_name || "dosya.bin";
                    lastEncAlgorithm = data.algorithm || document.getElementById("algo").value;
                    lastEncCiphertext = data.message;

                    if (st) st.innerText = `Şifreli dosya hazır: ${lastEncFileName} (İndirebilirsin)`;
                    showDownloadButtons(true);
                } else {
                    if (st) st.innerText = "Şifreli mesaj server'a ulaştı.";
                }
            }
        });

        function randomAsciiKey(len) {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let out = "";
            for (let i = 0; i < len; i++) {
                out += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return out;
        }

        function validateKeyAndEncrypt() {
            const key = document.getElementById('key').value.trim();
            const algo = document.getElementById('algo').value;

            // Manual modlarda anahtar zorunlu
            if ((algo === "AES (Manual)" || algo === "DES (Manual)") && !key) {
                alert("Anahtar girmeniz gerekmektedir!");
                return false;
            }

            if (algo === "AES (Manual)" && key.length !== 16) {
                alert("AES (Manual) için anahtar tam 16 karakter olmalı.");
                return false;
            }
            if (algo === "DES (Manual)" && key.length !== 8) {
                alert("DES (Manual) için anahtar tam 8 karakter olmalı.");
                return false;
            }

            const needsKey = ["Caesar","Vigenere","Substitution","Affine","Rail Fence","Route Cipher","Columnar Transposition","Polybius","Hill","DES (Manual)","AES (Manual)"];
            if (needsKey.includes(algo) && !key) {
                alert("Bu algoritma için anahtar zorunlu.");
                return false;
            }

            return true;
        }

        function sendMessage() {
            const message = document.getElementById('message').value.trim();
            const key = document.getElementById('key').value.trim();
            const algo = document.getElementById('algo').value;

            const fileMode = isFileMode();

            if (fileMode && !fileAlgoAllowed(algo)) {
                return alert("Dosya şifreleme sadece AES/DES (Manual/Library) ve RSA ile destekleniyor.");
            }

            if (!fileMode && !message) return alert("Mesaj boş olamaz!");
            if (fileMode && !selectedBinFileB64) return alert("Dosya seçmedin!");
            if (!validateKeyAndEncrypt()) return;

            // yeni gönderimde eski download butonları kapansın
            hideDownloadButtons();

            // Library mod: RSA ile session key üret & gönder, sonra payload'ı gönder
            if (algo === "AES (Library)" || algo === "DES (Library)") {
                if (!rsaPublicKeyPem) return alert("RSA public key henüz gelmedi!");

                const keyLen = (algo === "AES (Library)") ? 16 : 8;
                const sessionKeyText = randomAsciiKey(keyLen);

                const publicKey = forge.pki.publicKeyFromPem(rsaPublicKeyPem);
                const encryptedKeyBytes = publicKey.encrypt(sessionKeyText, 'RSA-OAEP');
                const encryptedKeyB64 = forge.util.encode64(encryptedKeyBytes);

                pendingSendPayload = fileMode
                    ? { is_file: true, file_name: selectedBinFileName, file_b64: selectedBinFileB64, message: "", algorithm: algo, key: "" }
                    : { message: message, algorithm: algo, key: "" };

                socket.emit('exchange_session_key', {
                    algorithm: algo,
                    encrypted_key: encryptedKeyB64
                });

                document.getElementById('status').innerText = "Oturum anahtarı gönderiliyor...";
                document.getElementById('message').value = "";
                return;
            }

            const payload = fileMode
                ? { is_file: true, file_name: selectedBinFileName, file_b64: selectedBinFileB64, message: "", algorithm: algo, key: key }
                : { message: message, algorithm: algo, key: key };

            socket.emit('send_message', payload);

            document.getElementById('status').innerText = fileMode ? "Dosya şifrelendi ve gönderildi! (Şifreli çıktı bekleniyor...)" : "Mesaj gönderildi!";
            document.getElementById('message').value = "";
        }
    </script>
</body>
</html>
