<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>İstemci</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>İstemci (Mesaj Gönder)</h2>

        <label>Mesaj:</label>
        <input type="text" id="message">

        <label>Anahtar:</label>
        <input
            type="text"
            id="key"
            placeholder="Manuel modlar: DES (Manual)=8 karakter, AES (Manual)=16 karakter. Diğerleri kendi anahtar formatına göre."
        >

        <label>Algoritma:</label>
        <select id="algo">
            <option value="Caesar">Caesar</option>
            <option value="Vigenere">Vigenere</option>
            <option value="Substitution">Substitution</option>
            <option value="Affine">Affine</option>
            <option value="Rail Fence">Rail Fence</option>
            <option value="Route Cipher">Route Cipher</option>
            <option value="Columnar Transposition">Columnar Transposition</option>
            <option value="Polybius">Polybius</option>
            <option value="Pigpen">Pigpen</option>
            <option value="Hill">Hill</option>

            <option value="DES (Manual)">DES (Manual)</option>
            <option value="DES (Library)">DES (Library)</option>

            <option value="AES (Manual)">AES (Manual)</option>
            <option value="AES (Library)">AES (Library)</option>

            <option value="RSA">RSA</option>
        </select>

        <button onclick="sendMessage()">Şifrele ve Gönder</button>

        <!-- Client tarafında şifreli mesajı göstermiyoruz -->
        <div class="encrypted" id="status"></div>

        <a href="/" class="back-home-btn">Ana Sayfaya Dön</a>
    </div>

    <script>
        const socket = io();

        let rsaPublicKeyPem = null;

        // Library modda RSA key exchange sonrası gönderilecek payload
        let pendingSendPayload = null;

        // RSA public key iste
        socket.emit('get_rsa_public_key');
        socket.on('rsa_public_key', (data) => {
            rsaPublicKeyPem = data.public_key;
        });

        // Server key exchange OK dönerse -> bekleyen mesajı gönder
        socket.on('key_exchange_ok', (data) => {
            if (data && data.ok) {
                document.getElementById('status').innerText = "Oturum anahtarı alındı. Mesaj gönderiliyor...";

                if (pendingSendPayload) {
                    socket.emit('send_message', pendingSendPayload);
                    pendingSendPayload = null;
                }
            } else {
                alert("Anahtar iletimi başarısız: " + (data && data.message ? data.message : ""));
                document.getElementById('status').innerText = "";
                pendingSendPayload = null;
            }
        });

        // Server hata event’i (send/decrypt/key exchange vs)
        socket.on('error', (data) => {
            alert("Hata: " + (data && data.message ? data.message : "Bilinmeyen hata"));
        });

        // Mesaj gönderiminden sonra client sadece "Mesaj Gönderildi!" yazar
        socket.on('message_sent', (data) => {
            document.getElementById('status').innerText = "Mesaj Gönderildi!";
        });

        function randomAsciiKey(len) {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let out = "";
            for (let i = 0; i < len; i++) {
                out += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return out;
        }

        function validateKeyAndEncrypt() {
            const key = document.getElementById('key').value.trim();
            const algo = document.getElementById('algo').value;

            // Manual modlarda anahtar zorunlu
            if ((algo === "AES (Manual)" || algo === "DES (Manual)") && !key) {
                alert("Anahtar girmeniz gerekmektedir!");
                return false;
            }

            // Manual anahtar uzunluğu kontrolü
            if (algo === "AES (Manual)" && key.length !== 16) {
                alert("AES (Manual) için anahtar tam 16 karakter olmalı.");
                return false;
            }
            if (algo === "DES (Manual)" && key.length !== 8) {
                alert("DES (Manual) için anahtar tam 8 karakter olmalı.");
                return false;
            }

            // Diğer anahtarlı algoritmalar (isteğe bağlı)
            const needsKey = ["Caesar","Vigenere","Substitution","Affine","Rail Fence","Route Cipher","Columnar Transposition","Polybius","Hill","DES (Manual)","AES (Manual)"];
            if (needsKey.includes(algo) && !key) {
                alert("Bu algoritma için anahtar zorunlu.");
                return false;
            }

            return true;
        }

        function sendMessage() {
            const message = document.getElementById('message').value.trim();
            const key = document.getElementById('key').value.trim();
            const algo = document.getElementById('algo').value;

            if (!message) return alert("Mesaj boş olamaz!");

            if (!validateKeyAndEncrypt()) return;

            // Library mod: RSA ile session key üret & gönder, sonra mesajı gönder
            if (algo === "AES (Library)" || algo === "DES (Library)") {
                if (!rsaPublicKeyPem) return alert("RSA public key henüz gelmedi!");

                const keyLen = (algo === "AES (Library)") ? 16 : 8;
                const sessionKeyText = randomAsciiKey(keyLen);

                const publicKey = forge.pki.publicKeyFromPem(rsaPublicKeyPem);
                const encryptedKeyBytes = publicKey.encrypt(sessionKeyText, 'RSA-OAEP');
                const encryptedKeyB64 = forge.util.encode64(encryptedKeyBytes);

                // Mesajı exchange sonrası göndereceğiz (key alanı boş!)
                pendingSendPayload = { message: message, algorithm: algo, key: "" };

                socket.emit('exchange_session_key', {
                    algorithm: algo,
                    encrypted_key: encryptedKeyB64
                });

                document.getElementById('status').innerText = "Oturum anahtarı gönderiliyor...";
                document.getElementById('message').value = "";
                return;
            }

            // Manual/klasik mod: direkt gönder (key ile)
            socket.emit('send_message', { message: message, algorithm: algo, key: key });

            document.getElementById('status').innerText = "Mesaj Gönderildi!";
            document.getElementById('message').value = "";
        }
    </script>
</body>
</html>
