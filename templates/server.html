<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sunucu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Sunucu (Mesaj Al & Deşifre Et)</h2>

        <label>Gelen Şifreli Mesaj:</label>
        <div class="encrypted" id="received">{{ message }}</div>

        <label>Anahtar:</label>
        <input
            type="text"
            id="key"
            placeholder="Manual modlar: DES (Manual)=8 karakter, AES (Manual)=16 karakter. Diğer algoritmalar kendi key formatına göre."
        >

        <label>Algoritma:</label>
        <select id="algo">
            <option value="Caesar">Caesar</option>
            <option value="Vigenere">Vigenere</option>
            <option value="Substitution">Substitution</option>
            <option value="Affine">Affine</option>
            <option value="Rail Fence">Rail Fence</option>
            <option value="Route Cipher">Route Cipher</option>
            <option value="Columnar Transposition">Columnar Transposition</option>
            <option value="Polybius">Polybius</option>
            <option value="Pigpen">Pigpen</option>
            <option value="Hill">Hill</option>

            <option value="DES (Manual)">DES (Manual)</option>
            <option value="DES (Library)">DES (Library)</option>

            <option value="AES (Manual)">AES (Manual)</option>
            <option value="AES (Library)">AES (Library)</option>

            <option value="RSA">RSA</option>
        </select>

        <button onclick="decryptMessage()">Deşifre Et</button>

        <div class="decrypted" id="decrypted"></div>

        <a href="/" class="back-home-btn">Ana Sayfaya Dön</a>
    </div>

    <script>
        const socket = io();

        const receivedDiv = document.getElementById('received');
        const decryptedDiv = document.getElementById('decrypted');

        // Client mesaj gönderince server'a düşen şifreli mesaj buraya gelir
        socket.on('receive_message', (data) => {
            receivedDiv.innerText = data.message || "";
            decryptedDiv.innerText = "";
        });

        socket.on('message_decrypted', (data) => {
            decryptedDiv.innerText = data.decrypted ?? "";
        });

        socket.on('error', (data) => {
            alert("Hata: " + (data && data.message ? data.message : "Bilinmeyen hata"));
        });

        function decryptMessage() {
            const algo = document.getElementById('algo').value;
            const key = document.getElementById('key').value.trim();
            const encrypted = receivedDiv.innerText.trim();

            if (!encrypted) {
                alert("Gelen şifreli mesaj boş!");
                return;
            }

            // Library modlarda key kullanıcıdan alınmıyor (session key server'da kayıtlı)
            if (algo === "AES (Library)" || algo === "DES (Library)" || algo === "RSA") {
                socket.emit('decrypt_message', { message: encrypted, algorithm: algo, key: "" });
                return;
            }

            // Manual uzunluk kontrolleri
            if (algo === "AES (Manual)" && key.length !== 16) {
                alert("AES (Manual) anahtarı tam 16 karakter olmalı.");
                return;
            }
            if (algo === "DES (Manual)" && key.length !== 8) {
                alert("DES (Manual) anahtarı tam 8 karakter olmalı.");
                return;
            }

            // Anahtar gerektiren algoritmalar
            const needsKey = [
                "Caesar","Vigenere","Substitution","Affine","Rail Fence","Route Cipher",
                "Columnar Transposition","Polybius","Hill","DES (Manual)","AES (Manual)"
            ];

            if (needsKey.includes(algo) && !key) {
                alert("Bu algoritma için anahtar zorunlu.");
                return;
            }

            socket.emit('decrypt_message', { message: encrypted, algorithm: algo, key: key });
        }
    </script>
</body>
</html>
